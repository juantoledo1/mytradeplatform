generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DATABASE_DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                    Int                          @id @default(autoincrement())
  email                 String                       @unique
  username              String                       @unique
  firstName             String
  lastName              String
  password              String
  isActive              Boolean                      @default(true)
  agreesToTerms         Boolean                      @default(false)
  termsAgreedAt         DateTime?
  termsVersion          String                       @default("1.0")
  profileCompleted      Boolean                      @default(false)
  dateJoined            DateTime                     @default(now())
  lastLogin             DateTime?
  createdAt             DateTime                     @default(now())
  updatedAt             DateTime                     @updatedAt
  bankAccounts          BankAccount[]
  chatMessagesSent      ChatMessage[]                @relation("Sender")
  chatAddedBy           ChatParticipant[]            @relation("ChatAddedBy")
  chatParticipants      ChatParticipant[]            @relation("ChatParticipant")
  conversationsCreated  Conversation[]               @relation("CreatedBy")
  items                 Item[]
  batchRecipients       NotificationBatchRecipient[]
  notificationSettings  NotificationUserSettings[]
  notificationsReceived Notification[]               @relation("Recipient")
  notificationsSent     Notification[]               @relation("Sender")
  paymentMethods        PaymentMethod[]
  paymentShippingSetup  PaymentShippingSetup?
  reviewsReceived       Review[]                     @relation("ReviewedTrader")
  reviewsGiven          Review[]                     @relation("Reviewer")
  shippingAddresses     ShippingAddress[]
  shippingPreferences   ShippingPreferences?
  termsAgreements       TermsAgreement[]
  ratingsReceived       TradeRating[]                @relation("RatedTrader")
  ratingsGiven          TradeRating[]                @relation("Rater")
  tradesOffering        Trade[]                      @relation("TraderOffering")
  tradesReceiving       Trade[]                      @relation("TraderReceiving")
  disputesOpened        Dispute[]                    @relation("DisputesOpened")
  disputesResolved      Dispute[]                    @relation("DisputesResolved")
  profile               UserProfile?
  wallet                UserWallet?

  @@index([email])
  @@index([agreesToTerms])
  @@index([profileCompleted])
  @@index([createdAt])
  @@map("users")
}

model UserProfile {
  id                 Int        @id @default(autoincrement())
  userId             Int        @unique
  phoneNumber        String?
  dateOfBirth        DateTime?
  bio                String?
  avatar             String?
  emailNotifications Boolean    @default(true)
  marketingEmails    Boolean    @default(false)
  city               String?
  state              String?
  country            String     @default("United States")
  traderSince        DateTime   @default(now())
  tradingRating      Decimal    @default(0.00) @db.Decimal(3, 2)
  totalTrades        Int        @default(0)
  successfulTrades   Int        @default(0)
  isVerifiedTrader   Boolean    @default(false)
  traderTier         TraderTier @default(BRONZE)
  specialties        String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  interests          Interest[] @relation("UserInterests")

  @@index([userId])
  @@index([city, state])
  @@index([createdAt])
  @@map("user_profiles")
}

model Interest {
  id          Int           @id @default(autoincrement())
  name        String        @unique
  description String?
  color       String        @default("#007bff")
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  items       Item[]        @relation("ItemInterests")
  users       UserProfile[] @relation("UserInterests")

  @@index([name])
  @@index([isActive])
  @@map("interests")
}

model NotificationType {
  id                  Int                        @id @default(autoincrement())
  name                String                     @unique
  displayName         String
  description         String?
  isActive            Boolean                    @default(true)
  requiresAction      Boolean                    @default(false)
  autoMarkRead        Boolean                    @default(false)
  defaultEmailEnabled Boolean                    @default(true)
  defaultPushEnabled  Boolean                    @default(true)
  defaultInAppEnabled Boolean                    @default(true)
  priority            NotificationPriority       @default(NORMAL)
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  batches             NotificationBatch[]
  userSettings        NotificationUserSettings[]
  notifications       Notification[]

  @@index([name])
  @@index([isActive])
  @@index([priority])
  @@map("notification_types")
}

model NotificationUserSettings {
  id                 Int              @id @default(autoincrement())
  userId             Int
  notificationTypeId Int
  emailEnabled       Boolean          @default(true)
  pushEnabled        Boolean          @default(true)
  inAppEnabled       Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  notificationType   NotificationType @relation(fields: [notificationTypeId], references: [id], onDelete: Cascade)
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationTypeId])
  @@index([userId])
  @@index([notificationTypeId])
  @@map("notification_user_settings")
}

model Notification {
  id                 Int                          @id @default(autoincrement())
  recipientId        Int
  senderId           Int?
  notificationTypeId Int
  title              String
  message            String
  contentType        String?
  objectId           String?
  isRead             Boolean                      @default(false)
  readAt             DateTime?
  emailSent          Boolean                      @default(false)
  emailSentAt        DateTime?
  pushSent           Boolean                      @default(false)
  pushSentAt         DateTime?
  metadata           Json                         @default("{}")
  actionUrl          String?
  expiresAt          DateTime?
  createdAt          DateTime                     @default(now())
  updatedAt          DateTime                     @updatedAt
  batchRecipients    NotificationBatchRecipient[]
  notificationType   NotificationType             @relation(fields: [notificationTypeId], references: [id], onDelete: Cascade)
  recipient          User                         @relation("Recipient", fields: [recipientId], references: [id], onDelete: Cascade)
  sender             User?                        @relation("Sender", fields: [senderId], references: [id])

  @@index([recipientId, createdAt])
  @@index([recipientId, isRead])
  @@index([notificationTypeId])
  @@index([senderId])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("notifications")
}

model NotificationBatch {
  id                 Int                          @id @default(autoincrement())
  name               String
  notificationTypeId Int
  status             BatchStatus                  @default(PENDING)
  titleTemplate      String
  messageTemplate    String
  scheduledFor       DateTime?
  totalRecipients    Int                          @default(0)
  sentCount          Int                          @default(0)
  failedCount        Int                          @default(0)
  createdAt          DateTime                     @default(now())
  startedAt          DateTime?
  completedAt        DateTime?
  recipients         NotificationBatchRecipient[]
  notificationType   NotificationType             @relation(fields: [notificationTypeId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
  @@map("notification_batches")
}

model NotificationBatchRecipient {
  id             Int               @id @default(autoincrement())
  batchId        Int
  recipientId    Int
  notificationId Int?
  status         RecipientStatus   @default(PENDING)
  errorMessage   String?
  sentAt         DateTime?
  batch          NotificationBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  notification   Notification?     @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  recipient      User              @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([batchId, recipientId])
  @@index([batchId])
  @@index([recipientId])
  @@index([status])
  @@map("notification_batch_recipients")
}

model Conversation {
  id                   Int               @id @default(autoincrement())
  conversationType     ConversationType  @default(DIRECT)
  title                String?
  description          String?
  createdById          Int
  contentType          String?
  objectId             String?
  isActive             Boolean           @default(true)
  isArchived           Boolean           @default(false)
  isPrivate            Boolean           @default(true)
  allowNewParticipants Boolean           @default(false)
  lastMessageAt        DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  messages             ChatMessage[]
  participants         ChatParticipant[]
  createdBy            User              @relation("CreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([conversationType])
  @@index([createdById])
  @@index([isActive])
  @@index([lastMessageAt])
  @@index([contentType, objectId])
  @@map("conversations")
}

model ChatParticipant {
  id             Int             @id @default(autoincrement())
  conversationId Int
  userId         Int
  role           ParticipantRole @default(MEMBER)
  isActive       Boolean         @default(true)
  isMuted        Boolean         @default(false)
  addedById      Int?
  joinedAt       DateTime        @default(now())
  leftAt         DateTime?
  lastReadAt     DateTime?
  addedBy        User?           @relation("ChatAddedBy", fields: [addedById], references: [id])
  conversation   Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User            @relation("ChatParticipant", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId, isActive])
  @@index([userId, isActive])
  @@index([lastReadAt])
  @@map("chat_participants")
}

model ChatMessage {
  id             Int           @id @default(autoincrement())
  conversationId Int
  senderId       Int
  messageType    MessageType   @default(TEXT)
  content        String
  file           String?
  fileName       String?
  fileSize       Int?
  mimeType       String?
  replyToId      Int?
  isEdited       Boolean       @default(false)
  isDeleted      Boolean       @default(false)
  deliveredAt    DateTime?
  metadata       Json          @default("{}")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  replyTo        ChatMessage?  @relation("ReplyTo", fields: [replyToId], references: [id])
  replies        ChatMessage[] @relation("ReplyTo")
  sender         User          @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([messageType])
  @@index([isDeleted])
  @@index([replyToId])
  @@map("chat_messages")
}

model UserWallet {
  id                     Int                 @id @default(autoincrement())
  userId                 Int                 @unique
  stripeCustomerId       String?
  availableBalance       Decimal             @default(0.00) @db.Decimal(10, 2)
  escrowBalance          Decimal             @default(0.00) @db.Decimal(10, 2)
  totalDeposited         Decimal             @default(0.00) @db.Decimal(12, 2)
  totalWithdrawn         Decimal             @default(0.00) @db.Decimal(12, 2)
  totalShippingPaid      Decimal             @default(0.00) @db.Decimal(10, 2)
  withdrawalLimitDaily   Decimal             @default(1000.00) @db.Decimal(8, 2)
  withdrawalLimitMonthly Decimal             @default(10000.00) @db.Decimal(10, 2)
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  user                   User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions           WalletTransaction[]

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([createdAt])
  @@map("user_wallets")
}

model PaymentMethod {
  id                    Int                 @id @default(autoincrement())
  userId                Int
  stripePaymentMethodId String
  paymentType           PaymentType
  lastFour              String?
  brand                 String?
  isDefault             Boolean             @default(false)
  isActive              Boolean             @default(true)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions          WalletTransaction[]

  @@index([userId])
  @@index([stripePaymentMethodId])
  @@index([isDefault])
  @@map("payment_methods")
}

model BankAccount {
  id                    Int      @id @default(autoincrement())
  userId                Int
  stripeBankAccountId   String
  bankName              String
  accountHolderName     String
  lastFour              String
  routingNumberLastFour String
  isVerified            Boolean  @default(false)
  isDefault             Boolean  @default(false)
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeBankAccountId])
  @@index([isDefault])
  @@map("bank_accounts")
}

model WalletTransaction {
  id                    Int               @id @default(autoincrement())
  walletId              Int
  transactionType       TransactionType
  amount                Decimal           @db.Decimal(10, 2)
  status                TransactionStatus @default(PENDING)
  description           String?
  stripePaymentIntentId String?
  stripeChargeId        String?
  paymentMethodId       Int?
  tradeId               Int?
  platformFee           Decimal           @default(0.00) @db.Decimal(8, 2)
  stripeFee             Decimal           @default(0.00) @db.Decimal(8, 2)
  balanceBefore         Decimal?          @db.Decimal(10, 2)
  balanceAfter          Decimal?          @db.Decimal(10, 2)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  completedAt           DateTime?
  paymentMethod         PaymentMethod?    @relation(fields: [paymentMethodId], references: [id])
  wallet                UserWallet        @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([transactionType])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([tradeId])
  @@index([createdAt])
  @@map("wallet_transactions")
}

model Item {
  id                  Int              @id @default(autoincrement())
  name                String
  description         String
  price               Decimal          @db.Decimal(10, 2)
  ownerId             Int
  isAvailableForTrade Boolean          @default(true)
  tradePreferences    String?
  minimumTradeValue   Decimal?         @db.Decimal(10, 2)
  acceptsCashOffers   Boolean          @default(true)
  isActive            Boolean          @default(true)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  files               ItemFile[]
  images              ItemImage[]
  owner               User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  shippingDetails     ShippingDetails?
  tradesAsOffered     Trade[]          @relation("ItemOffered")
  tradesAsRequested   Trade[]          @relation("ItemRequested")
  interests           Interest[]       @relation("ItemInterests")

  @@index([ownerId])
  @@index([isActive])
  @@index([isAvailableForTrade])
  @@map("items")
}

model ItemImage {
  id           Int      @id @default(autoincrement())
  itemId       Int
  storagePath  String
  url          String
  originalName String
  mimeType     String?
  fileSize     Int?
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  item         Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([isPrimary])
  @@map("item_images")
}

model ItemFile {
  id          Int      @id @default(autoincrement())
  itemId      Int
  file        String
  name        String
  fileType    FileType @default(OTHER)
  fileSize    Int?
  mimeType    String?
  description String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  item        Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([fileType])
  @@index([isPublic])
  @@map("item_files")
}

model ShippingDetails {
  id             Int      @id @default(autoincrement())
  itemId         Int      @unique
  shippingWeight Decimal  @db.Decimal(8, 2)
  length         Decimal  @db.Decimal(6, 2)
  width          Decimal  @db.Decimal(6, 2)
  height         Decimal  @db.Decimal(6, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  item           Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@map("shipping_details")
}

model ShippingAddress {
  id           Int      @id @default(autoincrement())
  userId       Int
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  zipCode      String
  country      String   @default("United States")
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
  @@map("shipping_addresses")
}

model ShippingPreferences {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique
  preferredCarrier Carrier  @default(USPS)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("shipping_preferences")
}

model PaymentShippingSetup {
  id             Int            @id @default(autoincrement())
  userId         Int            @unique
  shippingMethod ShippingMethod @default(STANDARD)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payment_shipping_setups")
}

model TermsAgreement {
  id                     Int      @id @default(autoincrement())
  userId                 Int
  itemDetailsAccurate    Boolean  @default(false)
  agreesToTerms          Boolean  @default(false)
  agreesToEscrow         Boolean  @default(false)
  understandsFundRelease Boolean  @default(false)
  ipAddress              String?
  userAgent              String?
  termsVersion           String   @default("1.0")
  createdAt              DateTime @default(now())
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([termsVersion])
  @@map("terms_agreements")
}

model Trade {
  id                  Int           @id @default(autoincrement())
  traderOfferingId    Int
  traderReceivingId   Int
  itemOfferedId       Int
  itemRequestedId     Int?
  cashAmount          Decimal?      @db.Decimal(10, 2)
  status              TradeStatus   @default(PENDING)
  notes               String?
  escrowReference     String?
  estimatedCompletion DateTime?
  createdAt           DateTime      @default(now())
  acceptedAt          DateTime?
  completedAt         DateTime?
  cancelledAt         DateTime?
  reviews             Review[]
  ratings             TradeRating[]
  disputes            Dispute[]
  itemOffered         Item          @relation("ItemOffered", fields: [itemOfferedId], references: [id], onDelete: Cascade)
  itemRequested       Item?         @relation("ItemRequested", fields: [itemRequestedId], references: [id], onDelete: Cascade)
  traderOffering      User          @relation("TraderOffering", fields: [traderOfferingId], references: [id], onDelete: Cascade)
  traderReceiving     User          @relation("TraderReceiving", fields: [traderReceivingId], references: [id], onDelete: Cascade)

  @@index([traderOfferingId])
  @@index([traderReceivingId])
  @@index([status])
  @@index([createdAt])
  @@map("trades")
}

model Review {
  id               Int      @id @default(autoincrement())
  tradeId          Int
  reviewerId       Int
  reviewedTraderId Int
  rating           Int
  description      String
  wouldTradeAgain  Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  reviewedTrader   User     @relation("ReviewedTrader", fields: [reviewedTraderId], references: [id], onDelete: Cascade)
  reviewer         User     @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  trade            Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@unique([tradeId, reviewerId])
  @@index([tradeId])
  @@index([reviewerId])
  @@index([reviewedTraderId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

model TradeRating {
  id                  Int      @id @default(autoincrement())
  tradeId             Int
  raterId             Int
  ratedTraderId       Int
  communicationRating Int
  itemConditionRating Int
  shippingRating      Int
  overallRating       Int
  feedback            String?
  wouldTradeAgain     Boolean  @default(true)
  createdAt           DateTime @default(now())
  ratedTrader         User     @relation("RatedTrader", fields: [ratedTraderId], references: [id], onDelete: Cascade)
  rater               User     @relation("Rater", fields: [raterId], references: [id], onDelete: Cascade)
  trade               Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@unique([tradeId, raterId])
  @@index([ratedTraderId])
  @@index([overallRating])
  @@index([createdAt])
  @@map("trade_ratings")
}

model Dispute {
  id            Int           @id @default(autoincrement())
  tradeId       Int
  openedById    Int
  reason        String
  description   String
  status        DisputeStatus @default(OPEN)
  resolution    String?
  resolvedById  Int?
  resolvedAt    DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  trade         Trade         @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  openedBy      User          @relation("DisputesOpened", fields: [openedById], references: [id], onDelete: Cascade)
  resolvedBy    User?         @relation("DisputesResolved", fields: [resolvedById], references: [id])

  @@index([tradeId])
  @@index([openedById])
  @@index([status])
  @@index([createdAt])
  @@map("disputes")
}

enum TraderTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum BatchStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum RecipientStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}

enum ConversationType {
  DIRECT
  GROUP
  TRADE
  SUPPORT
}

enum ParticipantRole {
  MEMBER
  ADMIN
  OWNER
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
  TRADE_OFFER
  LOCATION
  STICKER
}

enum PaymentType {
  CARD
  PAYPAL
  BANK_ACCOUNT
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  ESCROW_DEPOSIT
  ESCROW_RELEASE
  ESCROW_REFUND
  SHIPPING_PAYMENT
  TRADE_FEE
  REFUND
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum FileType {
  IMAGE
  DOCUMENT
  CERTIFICATE
  MANUAL
  RECEIPT
  WARRANTY
  VIDEO
  AUDIO
  OTHER
}

enum Carrier {
  USPS
  UPS
  FEDEX
  DHL
  OTHER
}

enum ShippingMethod {
  STANDARD
  EXPEDITED
  OVERNIGHT
  PICKUP
}

enum TradeStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  IN_ESCROW
  COMPLETED
  CANCELLED
  DISPUTED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  REJECTED
}
